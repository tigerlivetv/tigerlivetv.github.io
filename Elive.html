<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>LastLive Player</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<style>
  body { margin:0; background:#121212; color:#fff; font-family:sans-serif; }
  .container { max-width:960px; margin:2rem auto; }
  .video-wrapper { position:relative; border-radius:12px; overflow:hidden; }
  video { width:100%; height:auto; display:block; background:#000; }
  .watermark { position:absolute; top:.5rem; right:.5rem; width:72px; opacity:.85; z-index:3; pointer-events:none; }
  .badges { position:absolute; top:.5rem; left:.5rem; display:flex; gap:.5rem; z-index:3; }
  .viewer-badge { background:rgba(0,0,0,0.6); padding:.25rem .5rem; border-radius:.5rem; display:flex; align-items:center; gap:.25rem; font-size:.85rem; }
</style>
</head>
<body>

<div class="container">
  <div class="d-flex align-items-center justify-content-between mb-3">
    <h3>Nottingham Forest vs Brentford</h3>
    <span>Premier League | 17-08-2025 07:30 PM</span>
  </div>

  <div class="video-wrapper">
    <div class="badges">
      <span class="badge bg-danger">LIVE</span>
      <span class="viewer-badge"><i class="bi bi-eye"></i> <span id="viewerCount">0</span></span>
    </div>
    <video id="video" controls autoplay playsinline></video>
    <img src="https://lastlive.org/site/logo.png" class="watermark" alt="Logo">
  </div>
</div>

<script>
const video = document.getElementById('video');
const viewerCountEl = document.getElementById('viewerCount');
const asset = "PT.Eleven.Sports.2.HD";
const host = "https://live.lastlive.org";
const serverEndpoint = "http://localhost:3000/getStream";

let hls;
let renewTimer;

async function getStreamUrl() {
  try {
    const res = await fetch(`${serverEndpoint}?asset=${asset}`);
    const data = await res.json();
    // data: {url: "...", ttl: ...}
    return data.url;
  } catch(err) {
    console.error('Failed to get stream URL', err);
    return null;
  }
}

async function startPlayer() {
  const url = await getStreamUrl();
  if (!url) return alert("Stream URL not available");

  if (hls) hls.destroy();

  if (Hls.isSupported()) {
    hls = new Hls();
    hls.loadSource(url);
    hls.attachMedia(video);
    hls.on(Hls.Events.MANIFEST_PARSED, () => video.play().catch(()=>{}));
    hls.on(Hls.Events.ERROR, (ev, data)=>{
      if(data.fatal) hls.destroy();
    });
  } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
    video.src = url;
    video.addEventListener('loadedmetadata', ()=>video.play());
  } else alert("Your browser does not support HLS");

  // Auto refresh token every 2 minutes (replace with TTL*0.75)
  if(renewTimer) clearTimeout(renewTimer);
  renewTimer = setTimeout(startPlayer, 120000);
}

// Fake viewer count for demo (replace with actual API)
function updateViewers(){
  const count = Math.floor(Math.random()*1000); 
  viewerCountEl.textContent = count;
}
setInterval(updateViewers, 8000);

startPlayer();
updateViewers();
</script>
</body>
</html>
